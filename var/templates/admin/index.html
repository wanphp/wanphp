<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">

  <title>{{ title }}</title>

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="/fontawesome/css/all.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="/datatables/datatables.net-bs5/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="/datatables/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css">
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="/js/sweetalert2/sweetalert2.min.css">
  <!-- Select2 -->
  <link rel="stylesheet" href="/select2/css/select2.min.css">
  <link rel="stylesheet" href="/select2/bootstrap5/select2-bootstrap-5-theme.min.css">
  <!-- Theme style -->
  <link href="/adminlte/css/adminlte.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/js/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
  <link href="/css/custom.css" rel="stylesheet">
</head>

<body class="sidebar-expand-lg sidebar-mini bg-body-tertiary layout-fixed sidebar-open">
<div class="app-wrapper">
  <!-- Navbar -->
  <nav class="app-header navbar navbar-expand bg-body">
    <div class="container-fluid">
      <!-- Left navbar links -->
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
          <i class="fa-solid fa-bars"></i>
        </a></li>
        <li class="nav-item">
          <a href="javascript:" data-link="/admin/dashboard" class="nav-link">首页</a>
        </li>
        {% if Role<0 %}
        <li class="nav-item d-none d-md-block">
          <a href="javascript:" data-link="/admin/actions" class="nav-link">权限</a>
        </li>
        {% endif %}
      </ul>

      <!-- Right navbar links -->
      <ul class="navbar-nav ms-auto">
        <!-- SEARCH FORM -->
        {% block headnavsearch %}
        <li class="nav-item">
          <a class="nav-link" data-widget="navbar-search" href="#" role="button">
            <i class="fas fa-search"></i>
          </a>
        </li>
        {% endblock %}
        <!-- Messages Dropdown Menu -->
        {% block messages %}{% endblock %}
        <!-- Notifications Dropdown Menu -->
        {% block notifications %}{% endblock %}
        <li class="nav-item">
          <a class="nav-link" href="javascript:" id="clearcache"><i class="fas fa-broom"></i> </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{basePath}}/loginOut"><i class="fas fa-sign-out-alt"></i> 退出</a>
        </li>
      </ul>
    </div>
  </nav>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  <aside class="app-sidebar bg-body-secondary shadow-sm">
    <div class="sidebar-brand">
      <a href="javascript:" class="brand-link">
        <img src="{{ loginUser.headimgurl ?: '/adminlte/assets/img/AdminLTELogo.png' }}" alt="{{loginUser.name}}"
             class="brand-image rounded-5 shadow">
        <span class="brand-text fw-light">{{loginUser.name ?: '系统管理'}}</span>
      </a>
    </div>

    <!-- Sidebar -->
    <div class="sidebar-wrapper">
      <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="menu" data-accordion="false">
          {% for index, item in sidebar %}
          <li class="nav-item has-treeview">
            <a href="#" class="nav-link">
              <i class="nav-icon {{ item.icon }}"></i>
              <p>{{ item.name }}<i class="nav-arrow fas fa-angle-right"></i></p>
            </a>
            {% if item.children %}
            <ul class="nav nav-treeview">
              {% for nav in item.children %}
              <li class="nav-item">
                <a href="javascript:" data-link="{{ nav.route }}" class="nav-link">
                  <i class="far fa-circle nav-icon"></i>
                  <p>{{ nav.name }}</p>
                </a>
              </li>
              {% endfor %}
            </ul>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
      </nav>
      <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->
  </aside>

  <main class="app-main">
    <div class="app-content px-0 px-md-1">
      <div class="container-fluid pt-3">
        {% block container %}{% endblock %}
      </div>
    </div>
  </main>

  <footer class="app-footer"><!--begin::To the end-->
    <div class="float-end d-none d-sm-inline"><b>版本</b> 1.0.0</div>
    <strong>Copyright &copy; 2025 {{thisUri}}</strong> 版权所有。
  </footer>
</div>
<!-- ./wrapper -->

<div id="modalDialog" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title"></h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
    </div>
  </div>
</div>
<!-- jQuery -->
<script src="/jquery/jquery.min.js"></script>
<script src="/js/moment/moment.min.js"></script>
<script src="/js/moment/locale/zh-cn.js"></script>
<script src="/js/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>

<!-- Bootstrap 4 -->
<script src="/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- SweetAlert2 -->
<script src="/js/sweetalert2/sweetalert2.all.min.js"></script>
<!-- AdminLTE -->
<script src="/adminlte/js/adminlte.min.js"></script>
<!-- DataTables -->
<script src="/datatables/datatables.net/js/dataTables.min.js"></script>
<script src="/datatables/datatables.net-bs5/js/dataTables.bootstrap5.min.js"></script>
<script src="/datatables/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
<script src="/datatables/datatables.net-responsive-bs5/js/responsive.bootstrap5.min.js"></script>
<script src="/datatables/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
<script src="/datatables/datatables.net-buttons/js/buttons.html5.min.js"></script>
<script src="/js/dataTable.defaults.js"></script>
<!-- Select2 -->
<script src="/select2/js/select2.full.min.js"></script>
<script src="/select2/js/i18n/zh-CN.js"></script>
<script type="text/javascript">
  const currentUser = {
    uid: '{{loginUser.uid}}',
    head: '{{loginUser.headimgurl}}',
    nickname: '{{loginUser.nickname}}',
    name: '{{loginUser.name}}'
  };
  const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 3000});
  const basePath = '{{basePath}}';
  var timer;

  // 传入一个时间戳（毫秒）
  function formatTimestamp(timestamp) {
    if (timestamp.toString().length === 13) timestamp = Math.floor(timestamp / 1000);
    return moment.unix(timestamp).format('YYYY-MM-DD HH:mm:ss');
  }

  function dialog(title, content, callable) {
    Swal.fire({
      title: title,
      text: content,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      confirmButtonText: '确定',
      cancelButtonText: '取消'
    }).then((result) => {
      if (result.isConfirmed) {
        callable();
      }
    });
  }

  function errorDialog(data) {
    if (data.responseJSON) data = data.responseJSON;
    Swal.fire({icon: 'error', title: data.errMsg, confirmButtonText: '好的'}).then((result) => {
      if (result.isConfirmed && data.type === 'reload') location.reload();
    });
  }

  function loadDialog(config) {
    let dialogClass = '';
    if (config.middle) dialogClass += ' modal-dialog-centered';
    if (config.scrollable) dialogClass += ' modal-dialog-scrollable';
    switch (config.size) {
      case 'sm':
        dialogClass += ' modal-sm';
        break;
      case 'lg':
        dialogClass += ' modal-lg';
        break;
      case 'xl':
        dialogClass += ' modal-xl';
        break;
      case 'fullscreen':
        dialogClass += ' modal-fullscreen';
        break;
    }
    showLoading();
    $.ajax({
      url: basePath + config.url,
      type: 'GET',
      success: function (body) {
        modalDialog(config.title, body, dialogClass, config.buttons, config.callback, config.backdrop);
        swal.close();
      },
      error: errorDialog
    });
  }

  function modalDialog(title, body, dialogClass = 'modal-lg', buttons, callable = null, backdrop = 'true') {
    $('#modalDialog .modal-title').html(title);
    if (!body.includes('<div class="modal-body">')) {
      body = '<div class="modal-body">' + body + '</div>';
      if (buttons instanceof Array && buttons.length) {
        body += '<div class="modal-footer">';
        for (const button of buttons) {
          body += '<button  class="btn btn-' + button.type + '" data-value="' + button.value + '" data-hide="' + (button.hide ? button.hide : 'true') + '">' + button.text + '</button>';
        }
        body += '</div>';
      } else if (typeof buttons === 'string') {
        body += '<div class="modal-footer">' + buttons + '</div>';
      }
    }
    $('#modalDialog .modal-body, #modalDialog .modal-footer').remove();
    $('#modalDialog .modal-dialog .modal-content').append(body);

    $('#modalDialog .modal-dialog').attr('class', 'modal-dialog ' + dialogClass);
    if (backdrop === 'static') $('#modalDialog').modal('dispose');
    $('#modalDialog').attr('data-bs-backdrop', backdrop).off('click', '.modal-footer .btn,.modal-header .btn-close').on('click', '.modal-footer .btn,.modal-header .btn-close', function (event) {
      if (callable) {
        // 如果有表单且为提交按钮，取表格数据
        if (event.target.dataset.value && $(event.target).closest('.modal-content').find('form').length > 0) {
          const form = $(event.target).closest('.modal-content').find('form')[0];
          form.classList.add('was-validated');
          if (form.checkValidity()) {
            const formData = new FormData(form);
            // 将 FormData 转换为 JSON 对象
            const jsonObject = {};
            formData.forEach((value, key) => {
              // 如果该字段已经存在，尝试将其变成数组（针对复选框、多选等情况）
              if (jsonObject.hasOwnProperty(key)) {
                if (Array.isArray(jsonObject[key])) {
                  jsonObject[key].push(value);
                } else {
                  jsonObject[key] = [jsonObject[key], value];
                }
              } else {
                jsonObject[key] = value;
              }
            });
            callable(event.target.dataset.value, jsonObject);
            if (event.target.dataset.hide === 'true') $('#modalDialog').modal('hide');
          }
        } else {
          callable(event.target.dataset.value);
          if (event.target.dataset.hide === 'true') $('#modalDialog').modal('hide');
        }
      }
    }).off('hidden.bs.modal').on('hidden.bs.modal', function () {
      if (backdrop === 'static') $('#modalDialog').modal('dispose');
      $('#modalDialog .modal-body').remove();
      $('#modalDialog .modal-footer').remove();
      $('#modalDialog script').remove();
    }).modal('show');
  }

  function closeModalDialog() {
    $('#modalDialog').modal('hide');
  }

  function showLoading(title = '内容加载中') {
    Swal.fire({
      title: title,
      allowOutsideClick: false, // 不允许点击外部关闭
      showConfirmButton: false, // 不显示确认按钮
      didOpen: () => {
        Swal.showLoading();
      }
    });
  }

  function loadAppContent(url) {
    // 展开侧边栏
    if (window.screen.width > 768) (new adminlte.PushMenu($("[data-lte-toggle='sidebar']")[0])).expand();
    else (new adminlte.PushMenu($("[data-lte-toggle='sidebar']")[0])).collapse();
    showLoading();
    var checkSidebarInterval = setInterval(function () {
      clearInterval(checkSidebarInterval);
      $('.app-content .container-fluid').load(basePath + url + (url.indexOf('?') === -1 ? '?' : '&') + 'loadTpl=1', function (response, status) {
        swal.close();
        if (status === 'error') errorDialog(JSON.parse(response));
        console.log(status);
      });
    }, 100);
  }

  if (window.location.hash) loadAppContent(window.location.hash.substring(1));
  else loadAppContent('/admin/dashboard');

  window.addEventListener('popstate', function () {
    if (window.location.hash) {
      loadAppContent(window.location.hash.substring(1));
    } else {
      location.href = basePath;
    }
  });

  // 怎么随机密码
  function generateRandomString(length) {
    var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";
    var result = "";
    for (var i = 0; i < length; i++) {
      result += chars[Math.floor(Math.random() * chars.length)];
    }
    return result;
  }

  function loadScript(url, callback) {
    // 检查是否已经加载过该文件
    for (const element of document.querySelectorAll("script[src]")) {
      if (element.src.endsWith(url)) {
        if (callback && typeof (callback) === "function") callback();
        return;
      }
    }
    const script = document.createElement("script");
    script.type = "text/javascript";
    script.src = url;
    if (callback && typeof (callback) === "function") script.onload = callback;
    document.head.appendChild(script);
  }

  function loadCSS(url) {
    // 检查是否已经加载过该文件
    for (const element of document.querySelectorAll("link[href]")) {
      if (element.href.endsWith(url)) return;
    }
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.type = "text/css";
    link.href = url;
    document.head.appendChild(link);
  }

  $(function () {
    $('#clearcache').on('click', function () {
      $.get(basePath + '/clearCache', function (data) {
        location.reload();
      });
    });
    if (window.location.hash) {
      const menu = $('.sidebar-wrapper a[data-link="' + window.location.hash.substring(1) + '"]');
      menu.parents('li.has-treeview').addClass('menu-open');
      menu.parents('ul.nav-treeview').prev().addClass('active');
      menu.addClass('active');
    } else {
      $('.sidebar-wrapper li:eq(0)').addClass('menu-open');
      $('.sidebar-wrapper li:eq(0)>a').addClass('active');
    }
    $('.brand-link').on('click', function () {
      loadDialog({title: '用户信息', url: '/admin/editPassword'});
    });
    $('body').on('click touchstart', 'a[data-link]', function (e) {
      $(e.target).tooltip('hide');
      window.location.hash = e.currentTarget.dataset.link;
      if ($(this).hasClass('nav-link')) {
        $('.nav-item a.active').removeClass('active');
        $(e.currentTarget).parents('ul.nav-treeview').prev().addClass('active');
        $(e.currentTarget).addClass('active');
      }
    }).on('submit', 'form.needs-validation', function (e) {
      e.preventDefault();
      e.stopPropagation();
      e.target.classList.add('was-validated');
    }).tooltip({selector: '[data-bs-toggle="tooltip"]'})
      .on('click', '[data-lte-toggle="card-collapse"]', function (event) {
        event.preventDefault();
        (new adminlte.CardWidget(event.target)).toggle();
      });
  });
</script>
</body>
</html>
